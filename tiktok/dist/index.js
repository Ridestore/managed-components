"use strict";var C=Object.create;var i=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var k=(e,t)=>{for(var o in t)i(e,o,{get:t[o],enumerable:!0})},u=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of E(t))!S.call(e,r)&&r!==o&&i(e,r,{get:()=>t[r],enumerable:!(n=f(t,r))||n.enumerable});return e};var q=(e,t,o)=>(o=e!=null?C(v(e)):{},u(t||!e||!e.__esModule?i(o,"default",{value:e,enumerable:!0}):o,e)),w=e=>u(i({},"__esModule",{value:!0}),e);var R={};k(R,{default:()=>B});module.exports=w(R);var l=q(require("crypto")),_={email:{hashed:!0},phone_number:{hashed:!0}},M=e=>{let{client:t}=e,o=t.get("ttclid")||"";return t.url.searchParams?.get("ttclid")&&(o=t.url.searchParams.get("ttclid")??"",t.set("ttclid",o)),o},P=(e,t,o)=>{let{client:n,payload:r}=t,c=String(Math.round(Math.random()*1e17)),d={event:(e==="pageview"?"ViewContent":r.ev)||t.name||t.type,event_id:c,timestamp:new Date(n.timestamp).toISOString(),context:{page:{url:n.url.href},...!o.hideClientIP&&{user_agent:n.userAgent,ip:n.ip},user:{},ad:{}},properties:{}};return delete r.ev,d},s=async(e,t,o)=>{let n;e==="ecommerce"?n=t.payload.ecommerce:n=t.payload;let r=M(t),c=P(e,t,o),d=new TextEncoder;for(let[p,g]of Object.entries(_)){let a=n[p];if(a){if(g.hashed){let h=d.encode(a.trim().toLowerCase());a=await l.createHash("sha256").update(h).digest("hex")}c.context.user[p]=a,delete n[p]}}return r&&(c.context.ad={callback:r}),c};var x={"Order Completed":"CompletePayment","Product Added":"AddToCart","Products Searched":"Search","Checkout Started":"InitiateCheckout","Payment Info Entered":"AddPaymentInfo","Product Added to Wishlist":"AddToWishlist","Product Viewed":"ViewContent"},A=e=>(e.products||[{}]).map(o=>({content_type:"product",price:o.price||e.price,quantity:o.quantity||1,content_id:o.sku||o.product_id||e.sku||e.product_id})),T=e=>e.value||e.price||e.total||e.revenue,b=e=>{let{payload:t}=e,o=t.ecommerce,n={};return n.value=T(o),n.currency=o.currency,n.contents=A(o),e.name==="Products Searched"&&(n.query=o.query),n},y=async(e,t)=>{let o=b(e);delete e.payload.ecommerce.products;let n=await s("ecommerce",e,t);return n.event=x[e.name||""],delete n.properties.eventName,n.properties={...n.properties,...o},n};var m=async(e,t)=>{let o="https://business-api.tiktok.com/open_api/v1.2/pixel/track/",n={pixel_code:e.properties.pixelCode||t.pixelCode,...e,...t.testKey&&{test_event_code:t.testKey}};console.info(n),fetch(o,{method:"POST",headers:{"Access-Token":e.properties.accessToken||t.accessToken,"Content-Type":"application/json"},body:JSON.stringify(n)})};async function B(e,t){e.addEventListener("event",async o=>{let n=await s("event",o,t);m(n,t)}),e.addEventListener("pageview",async o=>{let n=await s("pageview",o,t);m(n,t)}),e.addEventListener("ecommerce",async o=>{let n=await y(o,t);m(n,t)})}0&&(module.exports={});
